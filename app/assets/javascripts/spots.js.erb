// Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.

$(document).ready(function() {
	$.ajax({
		type: 'GET',
		dataType: 'json',
		url: '/spots',
		success: function(response) { initialize(response); },
		error: function() { console.log('KO') }
	});

	function initialize(response) {
		var mapContainer = document.getElementById('map-container');
		var spots = [];

		for(var i = 0; i < response.length; i++) {
			spots.push(response[i]);				
		}

		var map;
	  	var mapOptions = {
	    	zoom: 11,
	    	mapTypeId: google.maps.MapTypeId.ROAD
	  	};

	  	var positions = [];
		
	  	for(var i = 0; i < spots.length; i++) {
	  		positions.push(spots[i]);
	  	}

	  	map = new google.maps.Map(mapContainer, mapOptions);

	  	if(navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position) {
		    	for(var i = 0; i < positions.length; i++) {
		    		var pos = new google.maps.LatLng(positions[i].latitude, positions[i].longitude);

		    		var marker = new google.maps.Marker({
		    			map: map,		    			
		    			position:pos,
		    			icon: '<%= asset_url('skateboard.png') %>',
		    			title: (i + 1).toString()
		    		});

		    		addClickEventForEachMarker(marker);
		    	}

		    	var yourPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

		    	var yourPositionMarker = new google.maps.Marker({
		    			map: map,
		    			position: yourPosition,
		    			draggable: true,
		    			icon: '<%= asset_url('bartSkater.gif') %>',
		    			title: 'You are here!'
		    	});

		    	google.maps.event.addDomListener(yourPositionMarker, 'dragend', function() {
		    		var latitude = yourPositionMarker.getPosition().lat();
		    		var longitude = yourPositionMarker.getPosition().lng();;

			    	var infoWindowYourPositionContent = '<a class="add-spot-button" href=/spots/new?latitude=' + latitude + '&longitude=' + longitude + '>Add spot here</a>';

			    	var infoWindowYourPosition = new google.maps.InfoWindow({
			    		content: infoWindowYourPositionContent
			    	});

		    		infoWindowYourPosition.open(map, yourPositionMarker);
		    	});

		    	function addClickEventForEachMarker(marker) {
		    		google.maps.event.addDomListener(marker, 'click', function() {
						var spotId = marker.getTitle();

						var infoWindowSpotsContent = '<a href=/spots/' + spotId + '>Go to this spot</a>';

				    	var infoWindowSpots = new google.maps.InfoWindow({
				    		content: infoWindowSpotsContent
				    	});

				    	infoWindowSpots.open(map, marker);
					});
		    	}		    	
				
				map.setCenter(yourPosition);
		    }, function() {
		    	handleNoGeolocation(true);
		    });
	    } else {
	    	handleNoGeolocation(false);
	  	}
	}

	function handleNoGeolocation(errorFlag) {
	    if (errorFlag) {
	    	var content = 'Error: The Geolocation service failed.';
	    } else {
	    	var content = 'Error: Your browser does not support geolocation.';
	    }
	}

	$('.hearts').mouseover(function() {
		var trickId = $(this).data('trick-id');
		var hearts = $(this).data('hearts');

		var allHearts = $('.hearts[data-trick-id=' + trickId + ']');
		
		for(var i = 0; i < hearts; i++) {
			allHearts[i].setAttribute('src', '<%= asset_url("skateHeart.png") %>');
		}
	});

	$('.hearts').mouseout(function() {
		var trickId = $(this).data('trick-id');
		$('.hearts[data-trick-id=' + trickId + ']').attr('src', '<%= asset_url("skateHeartBW.png") %>');
	});

	$('.hearts').on('click', function() {
		var spotId = $(this).data('spot-id');
		var trickId = $(this).data('trick-id');
		var hearts = $(this).data('hearts');

		$(this).data('selected', 'yes');						

		var allHearts = $('.hearts[data-trick-id=' + trickId + ']');
		
		for(var i = 0; i < hearts; i++) {
			allHearts[i].setAttribute('src', '<%= asset_url("skateHeart.png") %>');
		}

		$('.hearts[data-trick-id=' + trickId + ']').unbind();

		var trickRating = {
			spot_id: spotId,
			trick_id: trickId,
			hearts: hearts
		};

		$.ajax({
			type: 'POST',
			url: '/spots/' + spotId + '/rate-trick',
			data: { trickRating },
			dataType: 'json',
			success: function() { console.log('OK'); },
			error: function() { console.log('KO'); }
		});
	});
});